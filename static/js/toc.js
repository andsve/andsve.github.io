
function mark_active_toc(toc, id) {
	var links = $(toc).find("a");
	links.removeClass("active");
	links.filter("[href=#" + id + "]").addClass("active");
}

function generate_toc(elements, toc_holder, show_toc) {
	
	var toc_html = "<ul>";
	for (var i = 0; i < elements.length; i++)
	{
		var anchor = elements[i];

		var new_id = anchor.innerHTML.replace(/[\s/]+/g, '-').toLowerCase();
		anchor.id = new_id;

		toc_html += "<li><a href='#" + new_id + "'>" + anchor.innerHTML + "</a></li>";

		// fix scrollspy stuff
		anchor = $(anchor);

		var position = $(anchor).position();
		anchor.scrollspy({
			min: anchor.offset().top - anchor.height(),
			max: (i < elements.length-1) ? $(elements[i+1]).offset().top - anchor.height() : anchor.offset().top + 1000,
			onEnter: function(element, position) {
				mark_active_toc( toc_holder, element.id );
			}
		});

	}
	toc_html += "</ul>";

	if (show_toc || show_toc === undefined)
	{
		toc_holder.innerHTML = toc_html;
	} else {
		toc_holder.innerHTML = "";
	}

}

window.onload = function() {
	generate_toc($("#content>h2"), $("#toc")[0]);

	// ugly hack to jump to correct anchor that was generated by generate_toc()
	var old_hash = window.location.hash;
	window.location.hash = ""; 
	window.location.hash = old_hash;

	if (old_hash == "")
	{
		old_hash = $("#content>h2")[0].id;
	}
	mark_active_toc($("#toc")[0], old_hash)


}

